<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>排隊系統資料收集工具</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{
      --primary:#174287;--bg:#f6f8fb;--card:#ffffff;--shadow:0 2px 10px rgba(0,0,0,.05);
    }
    body{background:var(--bg);font-family:"Noto Sans TC","Segoe UI",sans-serif;}
    h1{color:var(--primary);font-size:1.8rem;font-weight:700;}
    .table thead th,.table tbody td{text-align:center;vertical-align:middle;}
    .metrics-box{background:var(--card);border-radius:.5rem;box-shadow:var(--shadow);padding:1rem;margin-top:1.5rem;}
    #chartsContainer{display:flex;flex-wrap:wrap;gap:2rem;}
    canvas{max-width:420px;background:var(--card);border-radius:.5rem;box-shadow:var(--shadow);padding:.5rem;}
    tfoot td{text-align:center;padding:.8rem 0;}
    details{font-size:.9rem;margin-top:.5rem;}
    summary{cursor:pointer;color:var(--primary);}
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-3">排隊系統資料收集工具</h1>

    <div class="row g-2 mb-3">
      <div class="col-auto">
        服務櫃數 S：
        <input id="serverInput" type="number" value="1" min="1"
               class="form-control form-control-sm" style="width:70px;">
      </div>
      <div class="col-auto d-flex align-items-end gap-2">
        <button id="btnCompute" class="btn btn-success btn-sm" disabled>計算統計</button>
        <button id="btnExport"  class="btn btn-outline-secondary btn-sm" disabled>匯出 Excel</button>
      </div>
    </div>

    <!-- 資料表 -->
    <div class="table-responsive">
      <table id="dataTable" class="table table-striped table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>到達時間<br>(HH:MM:SS)</th>
            <th>離開時間<br>(HH:MM:SS)</th>
            <th>間隔時間<br>(分鐘)</th>
            <th>服務時間<br>(分鐘)</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="5">
              <button id="btnAdd" class="btn btn-primary">➕ 新增顧客</button>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- 統計 & 圖表 -->
    <div id="metrics" class="metrics-box d-none"></div>
    <div id="chartsContainer" class="mt-4"></div>
  </div>

<script>
(() => {
  /*** 基本工具函式 ***/
  const tbody        = document.querySelector('#dataTable tbody');
  const addBtn       = document.getElementById('btnAdd');
  const computeBtn   = document.getElementById('btnCompute');
  const exportBtn    = document.getElementById('btnExport');
  const serverInput  = document.getElementById('serverInput');

  let idx = 0;
  const now  = () => Math.floor(Date.now() / 1000);
  const fmt  = s => new Date(s * 1000).toLocaleTimeString('zh-TW', {hour12:false});
  const mean = a => a.reduce((p,c)=>p+c,0) / a.length;
  const std  = a => { const m = mean(a); return Math.sqrt(a.reduce((s,x)=>s+(x-m)**2,0)/(a.length-1)); };
  const to4  = n => Number.isFinite(n) ? (+n).toFixed(4) : '∞';
  const factorial = n => n<=1 ? 1 : n*factorial(n-1);

  /*** 動態新增列 ***/
  function addRow() {
    idx++;
    const tr = document.createElement('tr');
    tr.dataset.id = idx;
    for(let i=0;i<5;i++) tr.appendChild(document.createElement('td'));

    const [idTd,arrTd,leaTd] = tr.children;
    idTd.textContent = idx;
    arrTd.innerHTML  = `<span class="arrival"></span><br>
                        <button class="btn btn-sm btn-primary record">到達</button>`;
    leaTd.innerHTML  = `<span class="leave"></span><br>
                        <button class="btn btn-sm btn-danger  record" disabled>離開</button>`;

    tbody.appendChild(tr);
  }

  /*** 到達 / 離開 按鈕事件 ***/
  tbody.addEventListener('click', e => {
    if(!e.target.classList.contains('record')) return;
    const tr = e.target.closest('tr');
    const [idTd,arrTd,leaTd,intTd,svcTd] = tr.children;

    if(e.target.textContent === '到達') {
      const t = now();
      tr.dataset.arrival = t;
      arrTd.querySelector('span').textContent = fmt(t);
      e.target.remove();
      leaTd.querySelector('button').disabled = false;

      const prev = tr.previousElementSibling;
      if(prev && prev.dataset.arrival) {
        const diffSec = t - prev.dataset.arrival;
        intTd.textContent = `${to4(diffSec/60)}(${diffSec})`;
      }

    } else { // 離開
      const t = now();
      tr.dataset.leave = t;
      leaTd.querySelector('span').textContent = fmt(t);
      e.target.remove();

      const diffSec = t - tr.dataset.arrival;
      svcTd.textContent = `${to4(diffSec/60)}(${diffSec})`;

      if(!tbody.querySelector('.record')) {
        computeBtn.disabled = false;
        exportBtn.disabled  = false;
      }
    }
  });

  /*** Kolmogorov–Smirnov 指數分布檢定 ***/
  function ksExp(arr) {
    const n = arr.length;
    if(n < 2) return {ok:false,msg:'樣本不足',p:0};

    const sorted = [...arr].sort((a,b)=>a-b);
    const lam = 1 / mean(sorted);
    let D = 0;
    sorted.forEach((x,i)=>{
      const Fexp = 1 - Math.exp(-lam * x);
      const Fi   = (i+1)/n;
      const diff = Math.max(Math.abs(Fexp-Fi), Math.abs(Fexp-i/n));
      if(diff > D) D = diff;
    });

    const z = Math.sqrt(n) * D;
    let p = 0;
    for(let k=1;k<=100;k++) p += Math.pow(-1,k-1)*Math.exp(-2*k*k*z*z);
    p = Math.min(Math.max(2*p,0),1);

    const crit = 1.36 / Math.sqrt(n);
    return {ok: D < crit, msg:`D=${to4(D)}, p=${to4(p)}`, p, lam};
  }

  /*** 直方圖 ***/
  let arrChart, svcChart;
  function buildHist(id,title,data){
    const cvs = document.createElement('canvas');
    cvs.id = id;
    document.getElementById('chartsContainer').appendChild(cvs);

    const min  = Math.min(...data);
    const max  = Math.max(...data);
    const bins = Math.max(5, Math.ceil(Math.sqrt(data.length)));
    const size = (max - min) / bins || 1;
    const freq = Array(bins).fill(0);
    data.forEach(v => {
      const idx = Math.min(bins-1, Math.floor((v-min)/size));
      freq[idx]++;
    });

    const labels = freq.map((_,i)=>`${(min+i*size).toFixed(2)}-${(min+(i+1)*size).toFixed(2)}`);
    return new Chart(cvs,{
      type:'bar',
      data:{labels,datasets:[{data:freq,barPercentage:1.0}]},
      options:{plugins:{title:{display:true,text:title},legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
  }

  /*** 統計計算 ***/
  function compute(){
    const rows = [...tbody.querySelectorAll('tr')];
    const arrivals   = rows.map(r=>+r.dataset.arrival).filter(Boolean);
    if(arrivals.length < 2) return alert('至少兩筆資料');

    const servicesSec = rows.map(r=>+r.dataset.leave - +r.dataset.arrival);
    const interMin    = [];
    for(let i=1;i<arrivals.length;i++) interMin.push((arrivals[i]-arrivals[i-1])/60);
    const serviceMin  = servicesSec.map(s=>s/60);

    /* 基本統計 */
    const mI = mean(interMin), sdI = std(interMin);
    const mS = mean(serviceMin), sdS = std(serviceMin);
    const lam = 1 / mI;
    const mu  = 1 / mS;
    const S   = parseInt(serverInput.value) || 1;

    /* 指數分布檢定 */
    const ksI = ksExp(interMin);
    const ksS = ksExp(serviceMin);
    const expOK = ksI.ok && ksS.ok;

    /* Queue performance */
    const rho = lam / (S * mu);       // 系統利用率
    let method, Lq, P0, formula, P0detail;

    if(expOK){ // M/M/S
      method = S===1 ? 'M/M/1' : `M/M/${S}`;

      if(S === 1){
        Lq = Math.pow(lam,2) / (mu * (mu - lam));
        formula = 'λ² / (μ(μ-λ))';
        P0 = 1 - rho > 0 ? 1 - rho : 0;
        P0detail = 'π₀(1+ρ+ρ²+⋯)=1 ⇒ π₀/(1-ρ)=1 ⇒ π₀=1-ρ = 1-λ/μ';
      } else {
        let sum = 0;
        for(let k=0;k<S;k++) sum += Math.pow(lam/mu,k) / factorial(k);
        const last = Math.pow(lam/mu,S) / (factorial(S)*(1-rho));
        P0 = 1 / (sum + last);

        Lq = P0 * Math.pow(lam/mu,S) * rho / (factorial(S) * Math.pow(1-rho,2));
        formula = 'Erlang-C：P₀(λ/μ)^S ρ / (S!(1-ρ)²)';
        P0detail = 'P₀^{-1}=∑_{k=0}^{S-1}(λ/μ)^k/k! + (λ/μ)^S /(S!(1-ρ))';
      }

    } else {  // G/G/S Kingman
      method = 'Kingman 近似 (G/G/S)';
      const CvA = sdI / mI, CvS = sdS / mS;
      const alpha = Math.sqrt(2*(S+1));
      Lq = Math.pow(rho,alpha) / (1-rho) * (CvA*CvA + CvS*CvS) / 2;
      formula = 'ρ^√(2(S+1))/(1-ρ)×((Cₐ²+Cₛ²)/2)';
      P0 = 'N/A';
      P0detail = 'G/G/S 中無閉式 P₀ 公式';
    }

    const Ls = Lq + lam / mu;
    const Wq = Lq / lam;
    const Ws = Ls / lam;

    /* －－ 人力建議 －－ */
    let suggestion, reason;
    if(rho > 0.85 || Wq > 1){
      suggestion = '建議「增加」服務人員';
      reason = `目前系統利用率 ρ = ${to4(rho)} 過高，平均等待時間 Wq = ${to4(Wq)} 分，顧客排隊時間偏長。增加服務櫃可降低等待時間及排隊長度。`;
    } else if(rho < 0.30 && Wq < 0.2){
      suggestion = '建議「減少」服務人員';
      reason = `系統利用率 ρ = ${to4(rho)} 偏低，平均等待時間僅 Wq = ${to4(Wq)} 分，服務人員閒置率高，可考慮精簡人力以降低成本。`;
    } else {
      suggestion = '維持現有服務人力';
      reason = `系統利用率 ρ = ${to4(rho)} 與平均等待時間 Wq = ${to4(Wq)} 分皆在可接受範圍，維持目前人力配置即可。`;
    }

    /* －－ 畫面輸出 －－ */
    const box = document.getElementById('metrics');
    box.classList.remove('d-none');
    const badge = ok => ok
      ? `<span class="badge bg-success">符合</span>`
      : `<span class="badge bg-danger">不符合</span>`;

    box.innerHTML = `
      <h4 class="mb-3">${method} Performance</h4>

      <p><strong>到達分布</strong> KS：${ksI.msg} ${badge(ksI.ok)}</p>
      <p><strong>服務分布</strong> KS：${ksS.msg} ${badge(ksS.ok)}</p>

      <details><summary>為何判定「符合指數分布」？</summary>
        <p>假設 H₀：「樣本來自指數分布」，H₁：「非指數分布」。若 KS 檢定 p-value ≥ 0.05，表示無足夠證據拒絕 H₀，因此視為<strong>符合</strong>指數分布。本例 p (到達) = ${to4(ksI.p)}, p (服務) = ${to4(ksS.p)}。</p>
      </details>

      <p class="mt-2">λ = 1/&#772;X<sub>a</sub> = 1/${to4(mI)} = <strong>${to4(lam)}</strong> 人/分 (SD=${to4(sdI)})</p>
      <p>μ = 1/&#772;X<sub>s</sub> = 1/${to4(mS)} = <strong>${to4(mu)}</strong> 人/分 (SD=${to4(sdS)})</p>

      <ul class="list-group list-group-flush">
        <li class="list-group-item">(a) ρ = λ/(Sμ) = ${to4(lam)}/(${S}×${to4(mu)}) = <strong>${to4(rho)}</strong></li>
        <li class="list-group-item">(b) Lq = ${formula} = <strong>${to4(Lq)}</strong> 人</li>
        <li class="list-group-item">(c) Ls = Lq + λ/μ = ${to4(Lq)} + ${to4(lam/mu)} = <strong>${to4(Ls)}</strong> 人</li>
        <li class="list-group-item">(d) Wq = Lq / λ = ${to4(Lq)}/${to4(lam)} = <strong>${to4(Wq)}</strong> 分</li>
        <li class="list-group-item">(e) Ws = Ls / λ = ${to4(Ls)}/${to4(lam)} = <strong>${to4(Ws)}</strong> 分</li>
        <li class="list-group-item">(f) P₀ = <strong>${P0==='N/A'?P0:to4(P0)}</strong></li>
      </ul>

      <details><summary>空系統機率 P₀ 推導</summary>
        <pre style="white-space:pre-wrap">${P0detail}</pre>
      </details>

      <div class="alert alert-warning mt-3" role="alert">
        <strong>人力配置建議：</strong>${suggestion}<br>${reason}
      </div>
    `;

    /* 直方圖 (重建) */
    document.getElementById('chartsContainer').innerHTML = '';
    if(arrChart) arrChart.destroy();
    if(svcChart) svcChart.destroy();
    arrChart = buildHist('arrHist', '到達間隔分布 (min)', interMin);
    svcChart = buildHist('svcHist', '服務時間分布 (min)', serviceMin);
  }

  /*** 匯出 Excel ***/
  function exportExcel(){
    const wb = XLSX.utils.book_new();
    const data = [["#","Arrival","Leave","Inter(min)(sec)","Service(min)(sec)"]];
    tbody.querySelectorAll('tr').forEach(r=>{
      data.push([...(r.children)].map(td=>td.textContent.trim()));
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), 'Data');
    XLSX.writeFile(wb, 'queue_data.xlsx');
  }

  /*** 事件綁定 ***/
  addBtn     .addEventListener('click', addRow);
  computeBtn .addEventListener('click', compute);
  exportBtn  .addEventListener('click', exportExcel);
})();
</script>
</body>
</html>
